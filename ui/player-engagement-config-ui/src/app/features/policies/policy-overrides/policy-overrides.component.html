<div class="page">
  <header class="page__header">
    <div>
      <h1>Segment overrides</h1>
      <p class="page__description">Map segments to specific policy versions.</p>
    </div>
    <div class="page__actions">
      <button type="button" (click)="load()" [disabled]="state().loading">Refresh</button>
      <button type="button" (click)="save()" [disabled]="submitting()">Save overrides</button>
      <a class="link-button" routerLink="/policies">Back to list</a>
    </div>
  </header>

  <section class="panel card">
    <form [formGroup]="form" class="form-grid" (ngSubmit)="save()">
      <div class="form-row">
        <label for="policyKey">Policy key</label>
        <input id="policyKey" type="text" formControlName="policyKey" placeholder="e.g. daily-login" />
      </div>
    </form>
  </section>

  <section class="panel card">
    <div class="list-header">
      <div>Segment key</div>
      <div>Policy version</div>
      <div></div>
    </div>

    @for (row of overrideRows.controls; track row; let i = $index) {
      <div class="list-row" [formGroup]="row">
        <div class="form-row compact">
          <input type="text" formControlName="segmentKey" placeholder="segment_a" />
          @if (isInvalid(row.controls.segmentKey)) {
            <p class="error">Segment must be alphanumeric/underscore, up to 32 chars.</p>
          }
        </div>
        <div class="form-row compact">
          <input type="number" formControlName="policyVersion" min="1" />
          @if (isInvalid(row.controls.policyVersion)) {
            <p class="error">Version must be positive.</p>
          }
        </div>
        <div class="actions">
          <button type="button" (click)="removeRow(i)" [disabled]="overrideRows.length === 1">Remove</button>
        </div>
      </div>
    }

    <div class="list-actions">
      <button type="button" (click)="addRow()">Add override</button>
    </div>
  </section>

  <section class="panel">
    @if (state().status) {
      <p class="meta">Last response status: {{ state().status }}</p>
    }

    @if (message()) {
      <div class="card success-card">
        <p>{{ message() }}</p>
      </div>
    }

    @if (state().error) {
      <div class="card error-card">
        <p>{{ state().error }}</p>
      </div>
    }
  </section>
</div>
