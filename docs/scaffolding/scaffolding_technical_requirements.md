| Section                               | Requirement             | Description / Details                                                                                                                                       |
| ------------------------------------- | ----------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Overview**                       | Purpose                 | Define local development scaffolding for the XP Grant subsystem, implemented in C# 8.0 with Orleans and PostgreSQL.                                         |
|                                       | Scope                   | Covers backend service scaffolding, database initialization, migrations, and minimal Angular UI for configuration. Excludes production deployment or CI/CD. |
|                                       | Dependencies            | .NET 8.0 SDK, Orleans framework (latest stable 8.x packages), PostgreSQL (local instance), Npgsql, Evolve migrations via the latest `InnoAndLogic.Persistence` NuGet package, Angular CLI (for admin UI).         |
| **2. Architecture**                   | Service                 | Single Orleans silo hosting the XP grant domain logic and a Minimal API surface for testing and configuration.                                              |
|                                       | Persistence             | PostgreSQL database using raw SQL through Npgsql and Evolve migration scripts.                                                                              |
|                                       | UI Layer                | Lightweight Angular web app for configuring XP rules and viewing existing rule sets.                                                                        |
|                                       | Containerization        | Optional; local environment assumed. Docker support can be added later if needed.                                                                           |
| **3. Development Environment**        | Language & Runtime      | C# 8.0 running on .NET 8.0.                                                                                                                                 |
|                                       | Project Structure       | Place `PlayerEngagement.sln` under `src/` with separate projects (initially `PlayerEngagement.Host` for the ASP.NET Core minimal API + Orleans silo, and `PlayerEngagement.Domain` for shared logic).                                                       |
|                                       | Database                | PostgreSQL v15+, schema `xp`.                                                                                                                               |
|                                       | Migration Tool          | Evolve, driven by `InnoAndLogic.Persistence` NuGet package.                                                                                                 |
|                                       | Testing Framework       | xUnit (no FluentAssertions).                                                                                                                                |
|                                       | Front-End Framework     | Angular 17+ for XP rule configuration.                                                                                                                      |
|                                       | Local Configuration     | Use `appsettings.Development.json` (and `appsettings.Local.json` if desired) to store PostgreSQL and Orleans options; populate connection settings via keys such as `Postgres:Host`, `Postgres:Port`, `Postgres:Database`, `Postgres:User`, `Postgres:Password`.                                                                                  |
| **4. Core Components**                | XP Service              | Implements grant logic, streak evaluation, caps, and rule lookup. Exposes REST API endpoints for grants, balances, ledgers, and rules.                      |
|                                       | XP Database Schema      | Includes tables: `xp_users`, `xp_ledger`, `xp_balance`, `xp_streaks`, `xp_rules`, and optional `xp_awards`. Ledger rows stay signed (non-zero) so debits are represented by negative amounts without needing an `is_credit` flag. All entities keyed by `user_id`. |
|                                       | Migration Scripts       | Evolve-compatible SQL files embedded from `src/PlayerEngagement.Infrastructure/Persistence/Migrations`. Scripts use the `${schema}` token, schema-qualified identifiers, and `${schema}.now_utc()` for timestamp defaults. Seed data remains under `/Sql/seed`. |
|                                       | Idempotency             | Enforced at database level using `idempotency_key` unique constraint in `xp_ledger`.                                                                        |
|                                       | Rules Engine            | Each rule defines base XP, caps, multipliers, and streak policies (as JSON).                                                                                |
| **5. Orleans Design**                 | Grains                  | `XpGrantGrain`, `XpStreakGrain`, `XpRuleGrain`. Each grain corresponds to a key domain object.                                                              |
|                                       | Grain Persistence       | Grains use repository pattern; actual persistence via Npgsql, not Orleans storage providers.                                                                |
|                                       | Concurrency Model       | Grants executed through per-user grains to ensure single-writer semantics and idempotency.                                                                  |
| **6. API Design**                     | `/xp/grant`             | Accepts `user_id`, `rule_key`, optional `context`, and `idempotency_key`. Returns applied XP and balance.                                                   |
|                                       | `/xp/balance/{user_id}` | Returns current XP balance and last updated timestamp.                                                                                                      |
|                                       | `/xp/ledger/{user_id}`  | Returns recent XP transactions.                                                                                                                             |
|                                       | `/xp/rules`             | CRUD endpoints for XP rule configuration, consumed by Angular UI.                                                                                           |
|                                       | `/xp/simulate`          | Simulates rule application without committing changes.                                                                                                      |
| **7. Front-End Requirements**         | Rule List               | Display table of XP rules (key, base XP, caps, multipliers, active flag).                                                                                   |
|                                       | Rule Editor             | Form-based editor to add/edit rule properties and submit to `/xp/rules`.                                                                                    |
|                                       | Connectivity            | CORS-enabled communication with backend API on localhost.                                                                                                   |
|                                       | Build Mode              | Angular app served separately during development; may later be bundled in ASP.NET project.                                                                  |
| **8. Testing Requirements**           | Unit Tests              | Validate XP grant, cap enforcement, streak logic, idempotency, and rule CRUD operations.                                                                    |
|                                       | Integration Tests       | Run against ephemeral PostgreSQL using Testcontainers or local DB instance.                                                                                 |
|                                       | Seed Data               | Include a few test rules (e.g., `daily_login`, `first_win_of_day`) and mock users.                                                                          |
| **9. Configuration & Initialization** | Environment Variables   | Define PostgreSQL credentials, schema name, and XP timezone.                                                                                                |
|                                       | Startup Tasks           | Run Evolve migrations automatically; initialize seeds if not present.                                                                                       |
|                                       | Logging                 | Structured console logs for all grant operations.                                                                                                           |
| **10. Non-Functional Requirements**   | Maintainability         | All scaffolding code must be clear, minimal, and extensible for future XP-related services.                                                                 |
|                                       | Observability           | Basic request logging and error reporting sufficient for local debugging.                                                                                   |
|                                       | Security                | No authentication required for local development; protected endpoints can be added later.                                                                   |
|                                       | Extensibility           | Support future expansion to multi-service setups (Identity, Matchmaking, etc.) without refactoring core XP logic.                                           |
