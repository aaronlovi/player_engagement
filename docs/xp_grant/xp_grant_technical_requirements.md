### Daily Login Bonus – XP Grant

**Section:** Technical Requirements

**Scope:** Server-side services, data, APIs, observability, and ops for the Daily Login XP Grant.

**Assumptions:** Relational DB (Postgres/MariaDB), backend in Elixir or C#/Orleans, k8s on AWS/GCP, Prometheus/Grafana, single primary region to start, IANA timezones.

| **ID** | **Title**                     | **Requirement**                                                                                                                                                       | **Rationale**                                   | **Acceptance Criteria**                                                                                  |
| ------ | ----------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------- | -------------------------------------------------------------------------------------------------------- |
| TR-01  | Policy-as-Data                | XP grant configuration (base XP, streak curves, grace, claim window, streak model, seasonal boosts, segments) must be stored as versioned policy documents.           | Live-ops tunability and auditability.           | CRUD endpoints for policies; each claim references `policy_version`; immutable history retained.         |
| TR-02  | Streak Models                 | Support configurable models: **Plateau/Cap**, **Weekly Cycle Reset**, **Decay/Soft Reset**, **Tiered Seasonal Reset**, **Meta-Reward Milestones**.                    | Business BR-16.                                 | Policy selects model; engine computes correct XP/streak transitions for each; unit tests per model.      |
| TR-03  | Reward Day Resolution         | Compute reward day on server using **Anchor Timezone** and **Claim Window** start (e.g., 05:00 local), DST-safe via IANA tz.                                          | Prevent timezone exploits; consistent day math. | For any UTC instant, reward-day id is deterministic; DST transitions covered by tests.                   |
| TR-04  | Idempotent Claim              | Enforce one claim per `(user_id, reward_day_id)` via **unique constraint**; retries return the same receipt.                                                          | No double-claim; stable UX.                     | Unique index exists; duplicate attempts return stored receipt and XP; concurrency tests pass under load. |
| TR-05  | Rolling Cooldown Guard        | Optional secondary guard: deny claims within `<min_cooldown_hours>` of last claim (e.g., 22h).                                                                        | Extra protection for edge-travel cases.         | Config flag; when enabled, requests inside window return last receipt.                                   |
| TR-06  | Streak State                  | Persist `streak_state(user_id, current_streak, last_claim_reward_day, grace_used, longest_streak, model_state)`; transitions are pure-function based on policy+today. | Deterministic state; easy to test.              | Given a sequence of days and misses, computed state matches spec across models.                          |
| TR-07  | XP Ledger                     | Append-only ledger `xp_ledger(user_id, amount, reason=DAILY_LOGIN, correlation_id, policy_version, created_at)`; no in-place edits.                                   | Audit, rollbacks, analytics.                    | Every claim writes exactly one ledger row; foreign-keys validated; totals reconcile.                     |
| TR-08  | Concurrency Control           | Use optimistic insert-with-unique-key (or `INSERT ... ON CONFLICT DO NOTHING/RETURNING`) to resolve races from multi-device claims.                                   | Correctness under concurrent requests.          | Soak tests show zero duplicate grants with 100x parallel calls.                                          |
| TR-09  | API Contracts                 | Expose `/daily-login/eligibility` and `/daily-login/claim`; return receipt, XP awarded, next boundary timestamp, and streak info.                                     | Consistent client integration.                  | OpenAPI/Protobuf (for gRPC) published; contract tests pass in CI.                                        |
| TR-10  | Segmentation                  | Apply policy by segment (e.g., new, returning, VIP, region). Segments evaluated server-side at claim time.                                                            | Targeted experiments.                           | Segment resolver returns policy id; overrides logged.                                                    |
| TR-11  | Timezone Governance           | Store `user.reward_tz` (IANA) and change events with cooldown (e.g., ≥7 days) and effective-next-boundary rule.                                                       | Prevent abuse while supporting travel.          | Attempted tz change within cooldown is rejected; audit trail exists; next-boundary switch verified.      |
| TR-12  | Seasonal Hooks                | Policy may specify a season id/date range; seasonal resets or multipliers apply only within range.                                                                    | Event cadence alignment.                        | Season activation flips behavior exactly at boundaries; tests around boundaries pass.                    |
| TR-13  | Operator Preview              | Provide a dry-run endpoint to preview tomorrow's award for a user under a given policy.                                                                               | Safe tuning and support tooling.                | `/daily-login/preview` returns computed XP, streak outcome, and reasons.                                 |
| TR-14  | Observability – Metrics       | Export Prometheus metrics: claims_total, already_claimed_total, xp_granted_sum, streak_length_hist, grace_usage_total, policy_version_count, latency, error_rate.     | Health and tuning.                              | Dashboards show per-policy and per-segment views; RED/SLO panels wired.                                  |
| TR-15  | Observability – Logs & Traces | Structured logs (JSON) with correlation/receipt_id; traces around claim orchestration; audit log of policy and tz changes.                                            | Debuggability.                                  | Logs sampled to 100% errors/1% success; trace spans visible in Grafana Tempo/Cloud Trace.                |
| TR-16  | SLOs & Alerts                 | SLO: 99.9% success for claim within 300ms p95; error budget alerts; anomaly alerts for spike in already_claimed or error_rate.                                        | Reliability.                                    | Alert rules deployed; synthetic checks run from ≥2 regions.                                              |
| TR-17  | Rate Limiting & Abuse         | Per-user and per-IP rate limits (e.g., 10 claims/min); device fingerprint optional; captcha on suspicious bursts.                                                     | Protect backend and economy.                    | Limits configurable; flagged events produce security audit logs.                                         |
| TR-18  | Data Retention                | Retain ledger and claim rows for ≥24 months; policy history indefinitely; PII minimized.                                                                              | Compliance and analytics.                       | TTL/archival jobs verified; GDPR/CCPA export delete hooks ready (if needed).                             |
| TR-19  | Migration & Backfill          | Provide migrations and one-off scripts to initialize streak_state from historical claims; backward-compatible policy rollout.                                         | Smooth launch.                                  | Blue/green deployment plan; dry-run backfill produces correct streaks.                                   |
| TR-20  | Multi-Env Safety              | Dev/stage/prod isolation; feature flags for policy rollout; config via env + secret manager.                                                                          | Safe operations.                                | No cross-env data bleed; flags toggle without restarts.                                                  |
| TR-21  | k8s Scaling                   | Stateless API pods with HPA on CPU/QPS; single-writer constraint avoided by unique-key strategy; DB pooled via sidecar/pgbouncer.                                     | Elastic scaling.                                | Load test to 5× baseline without errors; DB saturation alerting in place.                                |
| TR-22  | Caching                       | Cache read-only policy docs and tz rules (TTL 5–15m); do **not** cache claim writes.                                                                                  | Latency and cost.                               | Cache hit >90% on policy reads; stale cache invalidation on policy publish.                              |
| TR-23  | Client Resilience             | Clients may retry on 5xx with jittered backoff; server must be idempotent.                                                                                            | Mobile reliability.                             | Retries return same receipt; no duplicate XP under chaos testing.                                        |
| TR-24  | Security                      | AuthN via platform token; AuthZ ensures user acts on self; input validation; WAF; secrets via cloud KMS/Secret Manager.                                               | Baseline security posture.                      | Pen test passes; secrets not logged; least-priv DB role enforced.                                        |
| TR-25  | Documentation & Runbooks      | Developer docs for APIs & models; operator guide for policies; on-call runbook for incident response.                                                                 | Sustainable operations.                         | Docs published; “First 10 min of incident” checklist available.                                          |
| TR-26  | Testing Matrix                | Unit tests for models; property tests for streak transitions; integration tests for DB uniqueness; e2e tests across DST and timezone changes.                         | Prevent regressions.                            | CI pipeline blocks on coverage thresholds and model property-test success.                               |
| TR-27  | Internationalization          | Support localized time formats and UI strings returned in claim response (e.g., streak labels).                                                                       | Global readiness.                               | Localization keys present; locale selection round-trip verified.                                         |
| TR-28  | Data Export                   | Periodic export of aggregates to warehouse (e.g., BigQuery/Redshift) for analytics.                                                                                   | Product insights.                               | Daily job succeeds with reconciliation to source-of-truth counts.                                        |
| TR-29  | Feature Flags                 | Ability to enable/disable models or seasonal boosts per segment/region.                                                                                               | Controlled rollout.                             | Flags stored centrally; change audit logged; updates propagate within 60s.                               |
| TR-30  | Backward Compatibility        | Responses include stable fields; adding new models/fields is additive and non-breaking.                                                                               | Client stability.                               | Old clients continue to claim successfully after server upgrades.                                        |
